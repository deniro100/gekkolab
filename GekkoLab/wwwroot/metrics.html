<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GekkoLab - System Metrics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 50px auto; padding: 20px; }
        .nav { margin-bottom: 30px; }
        .nav a { color: #3498db; text-decoration: none; margin-right: 20px; font-size: 1.1em; }
        .nav a:hover { text-decoration: underline; }
        .nav a.active { color: #333; font-weight: bold; }
        .chart-container { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .chart-title { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; color: #333; }
        canvas { max-height: 400px; }
        .section-title { font-size: 1.5em; font-weight: bold; margin-top: 40px; margin-bottom: 20px; color: #333; border-bottom: 2px solid #764ba2; padding-bottom: 10px; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .metric-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; color: white; }
        .metric-card.cpu { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .metric-card.memory { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .metric-card.disk { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .metric-value { font-size: 2.5em; font-weight: bold; }
        .metric-label { font-size: 0.9em; opacity: 0.9; }
        .metric-detail { font-size: 0.8em; opacity: 0.7; margin-top: 5px; }
        .version-info { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px 20px; margin-bottom: 30px; }
        .version-info-title { font-size: 1.1em; font-weight: bold; color: #495057; margin-bottom: 10px; }
        .version-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        .version-item { font-size: 0.9em; }
        .version-item-label { color: #6c757d; }
        .version-item-value { color: #212529; font-weight: 500; }
    </style>
</head>
<body>
<h1>GekkoLab - System Metrics</h1>

<div class="nav">
    <a href="index.html">🏠 Dashboard</a>
    <a href="metrics.html" class="active">📊 System Metrics</a>
    <a href="settings.html">⚙️ Settings</a>
</div>

<!-- Version Information Section -->
<div class="version-info" id="versionInfo">
    <div class="version-info-title">🔧 System Information</div>
    <div class="version-grid">
        <div class="version-item">
            <span class="version-item-label">Version:</span>
            <span class="version-item-value" id="appVersion">Loading...</span>
        </div>
        <div class="version-item">
            <span class="version-item-label">Environment:</span>
            <span class="version-item-value" id="appEnvironment">--</span>
        </div>
        <div class="version-item">
            <span class="version-item-label">Machine:</span>
            <span class="version-item-value" id="machineName">--</span>
        </div>
        <div class="version-item">
            <span class="version-item-label">OS:</span>
            <span class="version-item-value" id="osVersion">--</span>
        </div>
        <div class="version-item">
            <span class="version-item-label">.NET Version:</span>
            <span class="version-item-value" id="dotnetVersion">--</span>
        </div>
        <div class="version-item">
            <span class="version-item-label">Build Date:</span>
            <span class="version-item-value" id="buildDate">--</span>
        </div>
    </div>
</div>

<!-- System Metrics Section -->
<div class="section-title">Current System Status</div>
<div id="systemMetrics">
    <div class="metrics-grid">
        <div class="metric-card cpu">
            <div class="metric-label">CPU Usage</div>
            <div class="metric-value" id="cpuValue">--%</div>
        </div>
        <div class="metric-card memory">
            <div class="metric-label">Memory Usage</div>
            <div class="metric-value" id="memoryValue">--%</div>
            <div class="metric-detail" id="memoryDetail">-- / -- GB</div>
        </div>
        <div class="metric-card disk">
            <div class="metric-label">Disk Usage</div>
            <div class="metric-value" id="diskValue">--%</div>
            <div class="metric-detail" id="diskDetail">-- / -- GB</div>
        </div>
    </div>
</div>

<div class="chart-container">
    <div class="chart-title">CPU Usage - Real-time (Last 10 minutes, 5-second intervals)</div>
    <canvas id="cpuRealtimeChart"></canvas>
</div>

<div class="chart-container">
    <div class="chart-title">CPU Usage - Aggregated (Last 2 hours, 1-minute averages)</div>
    <canvas id="cpuAggregatedChart"></canvas>
</div>

<div class="chart-container">
    <div class="chart-title">Memory Usage - Real-time (Last 10 minutes)</div>
    <canvas id="memoryRealtimeChart"></canvas>
</div>

<script>
    let cpuRealtimeChart = null;
    let cpuAggregatedChart = null;
    let memoryRealtimeChart = null;

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    async function fetchVersionInfo() {
        try {
            const response = await fetch('/api/version');
            if (!response.ok) throw new Error('Version info not available');
            const data = await response.json();

            document.getElementById('appVersion').textContent = data.version;
            document.getElementById('appEnvironment').textContent = data.environment;
            document.getElementById('machineName').textContent = data.machineName;
            document.getElementById('osVersion').textContent = data.osVersion;
            document.getElementById('dotnetVersion').textContent = data.dotnetVersion;
            document.getElementById('buildDate').textContent = new Date(data.buildDate).toLocaleString();
        } catch (err) {
            console.error('Error fetching version info:', err);
            document.getElementById('appVersion').textContent = 'Error loading';
        }
    }

    async function fetchSystemMetrics() {
        try {
            const response = await fetch('/api/metrics/realtime/latest');
            if (!response.ok) throw new Error('No metrics available');
            const data = await response.json();

            document.getElementById('cpuValue').textContent = data.cpuUsagePercent.toFixed(1) + '%';
            document.getElementById('memoryValue').textContent = data.memoryUsagePercent.toFixed(1) + '%';
            document.getElementById('memoryDetail').textContent = 
                formatBytes(data.memoryUsedBytes) + ' / ' + formatBytes(data.memoryTotalBytes);
            document.getElementById('diskValue').textContent = data.diskUsagePercent.toFixed(1) + '%';
            document.getElementById('diskDetail').textContent = 
                formatBytes(data.diskUsedBytes) + ' / ' + formatBytes(data.diskTotalBytes);
        } catch (err) {
            console.error('Error fetching system metrics:', err);
        }
    }

    async function fetchCpuRealtimeHistory() {
        try {
            const response = await fetch('/api/metrics/realtime/history?minutes=10');
            if (!response.ok) throw new Error('No realtime history available');
            const data = await response.json();

            if (data.length === 0) return;

            const labels = data.map(d => new Date(d.timestamp));
            const cpuData = data.map(d => d.cpuUsagePercent);

            const ctx = document.getElementById('cpuRealtimeChart').getContext('2d');

            if (cpuRealtimeChart) {
                cpuRealtimeChart.data.labels = labels;
                cpuRealtimeChart.data.datasets[0].data = cpuData;
                cpuRealtimeChart.update('none');
            } else {
                cpuRealtimeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'CPU Usage (%)',
                            data: cpuData,
                            borderColor: '#f5576c',
                            backgroundColor: 'rgba(245, 87, 108, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'minute',
                                    displayFormats: { minute: 'HH:mm' },
                                    tooltipFormat: 'HH:mm:ss'
                                },
                                ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 10 }
                            },
                            y: {
                                min: 0,
                                max: 100,
                                title: { display: true, text: 'CPU %' }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        } catch (err) {
            console.error('Error fetching CPU realtime history:', err);
        }
    }

    async function fetchMemoryRealtimeHistory() {
        try {
            const response = await fetch('/api/metrics/realtime/history?minutes=10');
            if (!response.ok) throw new Error('No realtime history available');
            const data = await response.json();

            if (data.length === 0) return;

            const labels = data.map(d => new Date(d.timestamp));
            const memoryData = data.map(d => d.memoryUsagePercent);

            const ctx = document.getElementById('memoryRealtimeChart').getContext('2d');

            if (memoryRealtimeChart) {
                memoryRealtimeChart.data.labels = labels;
                memoryRealtimeChart.data.datasets[0].data = memoryData;
                memoryRealtimeChart.update('none');
            } else {
                memoryRealtimeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Memory Usage (%)',
                            data: memoryData,
                            borderColor: '#4facfe',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'minute',
                                    displayFormats: { minute: 'HH:mm' },
                                    tooltipFormat: 'HH:mm:ss'
                                },
                                ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 10 }
                            },
                            y: {
                                min: 0,
                                max: 100,
                                title: { display: true, text: 'Memory %' }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        } catch (err) {
            console.error('Error fetching Memory realtime history:', err);
        }
    }

    async function fetchCpuAggregatedHistory() {
        try {
            const now = new Date();
            const from = new Date(now.getTime() - 2 * 60 * 60 * 1000); // 2 hours ago
            const response = await fetch(`/api/metrics/aggregated/history?from=${from.toISOString()}&to=${now.toISOString()}`);
            if (!response.ok) throw new Error('No aggregated history available');
            const data = await response.json();

            if (data.length === 0) return;

            const labels = data.map(d => new Date(d.timestamp));
            const cpuData = data.map(d => d.cpuUsagePercent);

            const ctx = document.getElementById('cpuAggregatedChart').getContext('2d');

            if (cpuAggregatedChart) {
                cpuAggregatedChart.data.labels = labels;
                cpuAggregatedChart.data.datasets[0].data = cpuData;
                cpuAggregatedChart.update('none');
            } else {
                cpuAggregatedChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'CPU Usage (1-min avg)',
                            data: cpuData,
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'minute',
                                    displayFormats: { minute: 'HH:mm' },
                                    tooltipFormat: 'MMM d, HH:mm'
                                },
                                ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 12 }
                            },
                            y: {
                                min: 0,
                                max: 100,
                                title: { display: true, text: 'CPU % (1-min average)' }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        } catch (err) {
            console.error('Error fetching CPU aggregated history:', err);
        }
    }

    // Initial load
    fetchVersionInfo();
    fetchSystemMetrics();
    fetchCpuRealtimeHistory();
    fetchMemoryRealtimeHistory();
    fetchCpuAggregatedHistory();

    // Refresh intervals
    setInterval(fetchSystemMetrics, 5000);
    setInterval(fetchCpuRealtimeHistory, 5000);
    setInterval(fetchMemoryRealtimeHistory, 5000);
    setInterval(fetchCpuAggregatedHistory, 60000);
</script>
</body>
</html>
