<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GekkoLab - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 50px auto; padding: 20px; }
        .nav { margin-bottom: 30px; }
        .nav a { color: #3498db; text-decoration: none; margin-right: 20px; font-size: 1.1em; }
        .nav a:hover { text-decoration: underline; }
        .nav a.active { color: #333; font-weight: bold; }
        .readings-container { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 30px; }
        .reading { background: #f5f5f5; padding: 20px; border-radius: 8px; flex: 1; min-width: 150px; }
        .reading.weather { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .reading.weather .label { color: rgba(255,255,255,0.8); }
        .reading.weather .value { color: white; }
        .value { font-size: 2em; font-weight: bold; color: #333; }
        .label { color: #666; font-size: 0.9em; }
        .timestamp { color: #999; font-size: 0.8em; margin-top: 10px; }
        .error { color: red; }
        .chart-container { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .chart-title { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; color: #333; }
        canvas { max-height: 300px; }
        .section-title { font-size: 1.5em; font-weight: bold; margin-top: 40px; margin-bottom: 20px; color: #333; border-bottom: 2px solid #e74c3c; padding-bottom: 10px; }
        .motion-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .motion-image-wrapper { background: #f5f5f5; padding: 20px; border-radius: 8px; text-align: center; }
        .motion-image { max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .motion-stats { background: #f5f5f5; padding: 20px; border-radius: 8px; }
        .motion-stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .motion-stat { background: white; padding: 15px; border-radius: 8px; text-align: center; }
        .motion-stat-value { font-size: 1.8em; font-weight: bold; color: #333; }
        .motion-stat-label { font-size: 0.85em; color: #666; }
        .no-image { padding: 100px 20px; color: #999; font-style: italic; }
        .charts-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (max-width: 768px) { .motion-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<h1>GekkoLab Dashboard</h1>

<div class="nav">
    <a href="index.html" class="active">🏠 Dashboard</a>
    <a href="metrics.html">📊 System Metrics</a>
</div>

<!-- Motion Detection Section -->
<div class="section-title">Motion Detection</div>
<div class="motion-container">
    <div class="motion-image-wrapper">
        <div class="chart-title">Latest Motion Capture</div>
        <div id="motionImageContainer">
            <div class="no-image">Loading...</div>
        </div>
        <div class="timestamp" id="motionTimestamp"></div>
    </div>
    <div class="motion-stats">
        <div class="chart-title">Capture Statistics</div>
        <div class="motion-stats-grid">
            <div class="motion-stat">
                <div class="motion-stat-value" id="totalFiles">--</div>
                <div class="motion-stat-label">Total Captures</div>
            </div>
            <div class="motion-stat">
                <div class="motion-stat-value" id="totalSize">--</div>
                <div class="motion-stat-label">Total Size</div>
            </div>
            <div class="motion-stat">
                <div class="motion-stat-value" id="capturesLastHour">--</div>
                <div class="motion-stat-label">Last Hour</div>
            </div>
            <div class="motion-stat">
                <div class="motion-stat-value" id="capturesLast24h">--</div>
                <div class="motion-stat-label">Last 24 Hours</div>
            </div>
        </div>
    </div>
</div>

<!-- Sensor Data Section -->
<div class="section-title">Sensor Data</div>
<div id="data">Loading...</div>

<div class="charts-grid">
    <div class="chart-container">
        <div class="chart-title">🌡️ Temperature - Last 2 Hours (Indoor Sensor vs Outdoor Weather)</div>
        <canvas id="temperatureChart"></canvas>
    </div>

    <div class="chart-container">
        <div class="chart-title">💧 Humidity - Last 2 Hours (Indoor Sensor vs Outdoor Weather)</div>
        <canvas id="humidityChart"></canvas>
    </div>

    <div class="chart-container">
        <div class="chart-title">🌬️ Pressure - Last 2 Hours (Indoor Sensor)</div>
        <canvas id="pressureChart"></canvas>
    </div>
</div>

<script>
    let temperatureChart = null;
    let humidityChart = null;
    let pressureChart = null;

    // ============ Motion Detection Functions ============
    async function fetchMotionLatest() {
        try {
            const infoResponse = await fetch('/api/motion/latest/info');
            if (!infoResponse.ok) {
                document.getElementById('motionImageContainer').innerHTML = '<div class="no-image">No motion captures available</div>';
                document.getElementById('motionTimestamp').textContent = '';
                return;
            }
            const info = await infoResponse.json();
            
            const imageUrl = `/api/motion/latest?t=${new Date(info.timestamp).getTime()}`;
            document.getElementById('motionImageContainer').innerHTML = `<img src="${imageUrl}" alt="Latest motion capture" class="motion-image" />`;
            document.getElementById('motionTimestamp').textContent = `Captured: ${new Date(info.timestamp).toLocaleString()}`;
        } catch (err) {
            document.getElementById('motionImageContainer').innerHTML = '<div class="no-image">No motion captures available</div>';
            document.getElementById('motionTimestamp').textContent = '';
        }
    }

    async function fetchMotionStatistics() {
        try {
            const response = await fetch('/api/motion/statistics');
            if (!response.ok) throw new Error('No statistics available');
            const stats = await response.json();

            document.getElementById('totalFiles').textContent = stats.totalFiles.toLocaleString();
            document.getElementById('totalSize').textContent = stats.totalSizeMB + ' MB';
            document.getElementById('capturesLastHour').textContent = stats.capturesLastHour.toLocaleString();
            document.getElementById('capturesLast24h').textContent = stats.capturesLast24Hours.toLocaleString();
        } catch (err) {
            console.error('Error fetching motion statistics:', err);
        }
    }

    // ============ Sensor Data Functions ============
    async function fetchLatest() {
        try {
            // Fetch both sensor and weather data
            const [sensorResponse, weatherResponse] = await Promise.all([
                fetch('/api/sensor/latest'),
                fetch('/api/weather/latest')
            ]);
            
            let sensorData = null;
            let weatherData = null;
            
            if (sensorResponse.ok) {
                sensorData = await sensorResponse.json();
            }
            
            if (weatherResponse.ok) {
                weatherData = await weatherResponse.json();
            }

            let html = '<div class="readings-container">';
            
            // Indoor sensor readings
            if (sensorData) {
                html += `
                    <div class="reading">
                        <div class="label">🏠 Indoor Temperature</div>
                        <div class="value">${sensorData.temperature.toFixed(1)} °C</div>
                    </div>
                    <div class="reading">
                        <div class="label">🏠 Indoor Humidity</div>
                        <div class="value">${sensorData.humidity.toFixed(1)} %</div>
                    </div>
                    <div class="reading">
                        <div class="label">🏠 Pressure</div>
                        <div class="value">${sensorData.pressure.toFixed(1)} mmHg</div>
                    </div>
                `;
            }
            
            // Outdoor weather readings
            if (weatherData) {
                html += `
                    <div class="reading weather">
                        <div class="label">🌍 ${weatherData.location} Temperature</div>
                        <div class="value">${weatherData.temperature.toFixed(1)} °C</div>
                    </div>
                    <div class="reading weather">
                        <div class="label">🌍 ${weatherData.location} Humidity</div>
                        <div class="value">${weatherData.humidity.toFixed(1)} %</div>
                    </div>
                `;
            }
            
            html += '</div>';
            
            if (sensorData) {
                html += `<div class="timestamp">Sensor updated: ${new Date(sensorData.timestamp).toLocaleString()}</div>`;
            }
            if (weatherData) {
                html += `<div class="timestamp">Weather updated: ${new Date(weatherData.timestamp).toLocaleString()}</div>`;
            }
            
            document.getElementById('data').innerHTML = html;
        } catch (err) {
            document.getElementById('data').innerHTML = `<p class="error">${err.message}</p>`;
        }
    }

    async function fetchSensorHistory() {
        try {
            const now = new Date();
            const from = new Date(now.getTime() - 2 * 60 * 60 * 1000);
            
            // Fetch both sensor and weather history
            const [sensorResponse, weatherResponse] = await Promise.all([
                fetch(`/api/sensor/history?from=${from.toISOString()}&to=${now.toISOString()}`),
                fetch(`/api/weather/history?from=${from.toISOString()}&to=${now.toISOString()}`)
            ]);
            
            let sensorData = [];
            let weatherData = [];
            
            if (sensorResponse.ok) {
                sensorData = await sensorResponse.json();
            }
            
            if (weatherResponse.ok) {
                weatherData = await weatherResponse.json();
            }

            // Update Temperature Chart
            updateTemperatureChart(sensorData, weatherData);
            
            // Update Humidity Chart
            updateHumidityChart(sensorData, weatherData);
            
            // Update Pressure Chart
            updatePressureChart(sensorData);
            
        } catch (err) {
            console.error('Error fetching sensor history:', err);
        }
    }

    function updateTemperatureChart(sensorData, weatherData) {
        const ctx = document.getElementById('temperatureChart').getContext('2d');
        
        const sensorLabels = sensorData.map(d => new Date(d.timestamp));
        const sensorTemps = sensorData.map(d => d.temperature);
        
        const weatherLabels = weatherData.map(d => new Date(d.timestamp));
        const weatherTemps = weatherData.map(d => d.temperature);

        const datasets = [
            {
                label: 'Indoor Sensor (BME280)',
                data: sensorLabels.map((t, i) => ({ x: t, y: sensorTemps[i] })),
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                tension: 0.3,
                fill: false
            }
        ];
        
        if (weatherData.length > 0) {
            datasets.push({
                label: 'Outdoor Weather (Redmond)',
                data: weatherLabels.map((t, i) => ({ x: t, y: weatherTemps[i] })),
                borderColor: '#9b59b6',
                backgroundColor: 'rgba(155, 89, 182, 0.1)',
                tension: 0.3,
                borderDash: [5, 5],
                fill: false
            });
        }

        if (temperatureChart) {
            temperatureChart.data.datasets = datasets;
            temperatureChart.update();
        } else {
            temperatureChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'minute', displayFormats: { minute: 'HH:mm' }, tooltipFormat: 'MMM d, HH:mm' },
                            ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 12 }
                        },
                        y: {
                            title: { display: true, text: 'Temperature (°C)' }
                        }
                    },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }
    }

    function updateHumidityChart(sensorData, weatherData) {
        const ctx = document.getElementById('humidityChart').getContext('2d');
        
        const sensorLabels = sensorData.map(d => new Date(d.timestamp));
        const sensorHumidity = sensorData.map(d => d.humidity);
        
        const weatherLabels = weatherData.map(d => new Date(d.timestamp));
        const weatherHumidity = weatherData.map(d => d.humidity);

        const datasets = [
            {
                label: 'Indoor Sensor (BME280)',
                data: sensorLabels.map((t, i) => ({ x: t, y: sensorHumidity[i] })),
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.3,
                fill: false
            }
        ];
        
        if (weatherData.length > 0) {
            datasets.push({
                label: 'Outdoor Weather (Redmond)',
                data: weatherLabels.map((t, i) => ({ x: t, y: weatherHumidity[i] })),
                borderColor: '#1abc9c',
                backgroundColor: 'rgba(26, 188, 156, 0.1)',
                tension: 0.3,
                borderDash: [5, 5],
                fill: false
            });
        }

        if (humidityChart) {
            humidityChart.data.datasets = datasets;
            humidityChart.update();
        } else {
            humidityChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'minute', displayFormats: { minute: 'HH:mm' }, tooltipFormat: 'MMM d, HH:mm' },
                            ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 12 }
                        },
                        y: {
                            title: { display: true, text: 'Humidity (%)' },
                            min: 0,
                            max: 100
                        }
                    },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }
    }

    function updatePressureChart(sensorData) {
        const ctx = document.getElementById('pressureChart').getContext('2d');
        
        const labels = sensorData.map(d => new Date(d.timestamp));
        const pressures = sensorData.map(d => d.pressure);

        const datasets = [
            {
                label: 'Indoor Sensor (BME280)',
                data: labels.map((t, i) => ({ x: t, y: pressures[i] })),
                borderColor: '#2ecc71',
                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                tension: 0.3,
                fill: true
            }
        ];

        if (pressureChart) {
            pressureChart.data.datasets = datasets;
            pressureChart.update();
        } else {
            pressureChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'minute', displayFormats: { minute: 'HH:mm' }, tooltipFormat: 'MMM d, HH:mm' },
                            ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 12 }
                        },
                        y: {
                            title: { display: true, text: 'Pressure (mmHg)' }
                        }
                    },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }
    }

    // Initial load
    fetchMotionLatest();
    fetchMotionStatistics();
    fetchLatest();
    fetchSensorHistory();

    // Refresh intervals
    setInterval(fetchMotionLatest, 10000);
    setInterval(fetchMotionStatistics, 30000);
    setInterval(fetchLatest, 60000);
    setInterval(fetchSensorHistory, 60000);
</script>
</body>
</html>
